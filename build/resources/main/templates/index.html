<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Index Upload Page</title>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <style>
        #previewModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        #previewModal img {
            max-width: 80%;
            max-height: 80%;
            border: 5px solid #fff;
            border-radius: 8px;
        }
        #previewModal button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: red;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>

</head>
<body>

<h2>Upload Image, Video, or PDF</h2>

    <form id="uploadForm" th:action="@{/upload}" method="post" enctype="multipart/form-data">

        <input type="file" name="file" id="fileInput"  required>
        <input type="hidden" name="oldFileName" id="oldFileName">
        <button type="submit">Upload</button>
    </form>


    <h3>Uploaded Images:</h3>
    <h3 id="message" th:text="${message}"></h3>
    <div>
        <div th:if="${#lists.isEmpty(images)}">
            <p>No images uploaded yet.</p>
        </div>

        <table border="1">
            <tr>
                <th>Preview</th>
                <th>Count</th>
                <th>File Name</th>
                <th>Actions</th>
                <th>Actions</th>
                <th>Actions</th>
            </tr>
            <tr th:each="fileName, stat : ${images}" th:attr="data-filename=${fileName}">
                <td><img  th:src="@{'/images/' + ${fileName}}" width="100" alt="Image"/></td>
                <td><p th:text="${stat.count}"></p></td>
                <td th:text="${fileName}"></td>
                <td>
                    <button type="button" class="viewBtn"  th:attr="data-filename=${fileName}">View</button>
                </td>
                <td>
                    <button type="button" class="editBtn">Modify</button>
                    <button type="button" class="deleteBtn">Delete</button>
                </td>

                <td>
                    <a th:href="@{'/files/view/' + ${fileName}}" target="_blank" class="btn btn-info">View</a>
                </td>

            </tr>
        </table>


        <!-- ✅ Image Preview Modal -->
        <div id="previewModal">
            <button id="closeModal">X</button>
            <img id="previewImage" src="" alt="Preview">
        </div>


    </div>

<h3>PDFs</h3>
<table>
    <tr><th>Preview</th><th>Filename</th><th>Action</th></tr>
    <tr th:each="fileName : ${pdfs}">
        <td>
            <iframe th:src="@{'/pdfs/' + ${fileName}}" width="150" height="100"></iframe>
        </td>
        <td th:text="${fileName}"></td>
        <td>
            <button type="button" th:attr="data-type='pdfs', data-name=${fileName}"  class="deleteBtn">Delete</button>
        </td>
    </tr>
</table>


    <script>

        $(document).ready(function() {
            // Delete image using jQuery AJAX
            $('.deleteBtn').click(function() {
                const row = $(this).closest('tr');
                const fileName = row.data('filename');
                if (confirm('Are you sure you want to delete ' + fileName + '?')) {

                    $.ajax({
                        url: '/delete/' + fileName,
                        type: 'DELETE',
                        success: function(result) {
                            if (result.status === 'success') {
                                row.remove();
                                $('#message').text(result.message);
                            } else {
                                alert('Error deleting file!');
                            }
                        },
                        error: function() {
                            alert('Error deleting file!');
                        }
                    });
                }
            });

            // Modify file using jQuery
            $('.editBtn').click(function() {
                const row = $(this).closest('tr');
                const fileName = row.data('filename');
                if (confirm('Do you want to replace ' + fileName + '?')) {
                    $('#oldFileName').val(fileName);
                    $('#fileInput').click();
                }
            });

            // ✅ Delegate click event to dynamically loaded buttons
           /* $(document).on('click', '.viewBtn', function () {
                const fileName = $(this).data('filename');
                const imgUrl = `/files/view/${fileName}`;

                $('#previewImage').attr('src', imgUrl);
                $('#previewModal').fadeIn();
            }); */

            // ✅ When click "View" → go to view page
            $(document).on('click', '.viewBtn', function () {
                const fileName = $(this).data('filename');
                window.location.href = '/files/show/' + fileName;
            });

            // ✅ Close preview modal
            $('#closeModal').on('click', function () {
                $('#previewModal').fadeOut();
            });

            // Submit form automatically after selecting file
            $('#fileInput').change(function() {
                if (this.files.length > 0) {
                    $('#uploadForm').submit();
                }
            });

        });




    </script>
</body>
</html>